# Monte Carlo Forecast Pipeline (Basis 850)

This document summarizes the decisions, assumptions, and implementation details we agreed while building the Monte Carlo forecasting pipeline for the Basis 850 decline/improvement model.

## Goal

Generate two **new** Excel workbooks (not modifying the input workbook):

- `MonteCarlo_Decline.xlsx`: no-intervention / decline trajectory
- `MonteCarlo_Improvement.xlsx`: intervention trajectory

Each workbook contains **one sheet per client** named `CLIENT NAME_AGE` and includes **baseline + predicted mean values** for **all tests** at:

- Baseline (from the client database)
- Year 5 (Monte Carlo mean of observed values)
- Year 10 (Monte Carlo mean of observed values)

Only the **mean** is exported (no percentiles yet).

## Inputs

Client database:

- `Sample Persona Database (Monte Carlo).xlsx`
- Layout expectation: each sheet is a key/value table in columns `A` (label) and `B` (value)
- Tests are read from labels matching the sample format (e.g., `VO2 max (ml/kg/min)`, `Sit and reach (cm)`)
- `Fasting glucose (mmol/L)` is intentionally ignored

Rates source-of-truth:

- We initially extracted decline/improvement rates from:
  - `Decline Rates by test.docx`
  - `Improvement Rates Summary Table.docx`
- For repeatability, the pipeline uses a **config file** instead of parsing `.docx` each run:
  - `mc_assumptions.json`

## Outputs

Pipeline writes into an output folder:

- `outputs/MonteCarlo_Decline.xlsx`
- `outputs/MonteCarlo_Improvement.xlsx`

You can override the output directory per run.

## How To Run

From `Monte Carlo`:

```powershell
.\run_monte_carlo.ps1 -Input "Your Client File.xlsx"
```

Common overrides:

```powershell
# Choose a different output folder
.\run_monte_carlo.ps1 -Input "Clients_2026-02-11.xlsx" -OutputDir "outputs\2026-02-11"

# Change Monte Carlo iterations and make the run reproducible
.\run_monte_carlo.ps1 -Input "Clients_2026-02-11.xlsx" -Simulations 20000 -Seed 123
```

Notes on overrides:

- `-Simulations` changes the number of Monte Carlo scenarios per client.
- `-Seed` fixes randomness so the same input + seed yields the same output.

## Implementation Files

- `mc_pipeline.py`: the core pipeline runner
- `mc_assumptions.json`: all assumptions and parameters
- `run_monte_carlo.ps1`: PowerShell wrapper for convenience

## Test Set (Exported)

The pipeline exports these tests (in this order):

- VO2 max
- FEV1
- Grip Strength
- STS Power
- Vertical Jump
- Body Fat %
- Waist to Height Ratio
- HbA1c
- HOMA-IR
- ApoB
- hsCRP
- Gait Speed
- Timed Up and Go
- Single Leg Stance
- Sit and Reach
- Processing Speed
- Working Memory

## Directionality (What "Decline" Means)

Higher-is-better tests (decline decreases value; improvement increases value):

- VO2 max, FEV1
- Grip Strength, STS Power, Vertical Jump
- Gait Speed, Single Leg Stance, Sit and Reach
- Processing Speed, Working Memory

Lower-is-better tests (decline increases value; improvement decreases value):

- Body Fat %, Waist-to-Height Ratio
- HbA1c, HOMA-IR
- ApoB, hsCRP
- Timed Up and Go

Important edge case:

- Some tests can be negative (notably `Sit and Reach`, plus cognition scores).
- We fixed a bug where negative values were being clamped to `0` and where “decline” incorrectly moved negative values toward `0`.
- Negative values are allowed for the configured list `allow_negative_tests` in `mc_assumptions.json`.

## Decline Model

### Rates

Decline rates are defined as per-decade rates for each test:

- Base decline rate (per decade)
- Post-threshold decline rate (per decade)
- Acceleration threshold age (“post-60” style rule, per test)

Mechanics:

- Values compound over time using per-decade rates scaled by `years/10`.
- If the client crosses the “accelerated from age” boundary during the forecast window, the model applies:
  - Base rates up to the threshold age
  - Post rates after the threshold age

### Rate Uncertainty (Level 1)

Each simulation samples a person-specific “true decline rate” around the table mean.

Distributions:

- Normal, truncated at `0` for most tests
- Lognormal for `HOMA-IR` and `hsCRP` rates

Default rate CVs (by group, locked into config):

- Performance / functional: `25%`
- Adiposity: `30%`
- HbA1c: `20%`
- ApoB: `25%`
- HOMA-IR: `50%` (lognormal)
- hsCRP: `80%` (lognormal)

### Measurement Noise (Level 2)

Observed values at Year 5 and Year 10 are generated by adding per-observation noise:

- Normal for most tests
- Lognormal for `HOMA-IR` and `hsCRP` observation noise

Defaults in config (CV of observation):

- VO2 max: 5%
- FEV1: 3%
- Grip strength: 5%
- STS/Vertical jump: 6%
- Gait speed: 4%
- TUG: 5%
- Sit-and-reach: 6%
- Single-leg stance: 12%
- Body fat: 4%
- WHtR: 2%
- HbA1c: 3%
- HOMA-IR: 20% (lognormal)
- ApoB: 4%
- hsCRP: 45% (lognormal)
- Cognition: 5%

Baseline handling:

- Baseline in the client database is treated as an observed value.
- Each simulation infers a latent “true baseline” by applying an inverse measurement-noise draw, then evolves that true baseline forward.

## Improvement Model

We output a separate workbook for the “improvement” trajectory.

Key rule: **one-time improvement in Year 1**, then decline applies for the remaining years.

Other key decisions:

- All improvements are treated as **relative (% multipliers)** in their native units.
- Body fat improvement is interpreted as “0.5–1% absolute reduction per month” and converted to “6–12% relative reduction over a year” for the year-1 improvement step.
- VO2 max improvement:
  - Age < 60: 15–25%
  - Age >= 60: 10–15%
- ApoB and hsCRP use conservative/lifestyle ranges:
  - ApoB: 5–15% reduction
  - hsCRP: 10–25% reduction
- HOMA-IR improvement is modeled as a lognormal reduction factor with a wide range:
  - Reduction fraction roughly 15%–50% (median ~30%), clamped to a max 80% reduction

## Correlations (Rate Sampling)

Decline-rate sampling is correlated to avoid unrealistic “mixed metabolic” individuals.

We correlate rates on a latent normal scale for a subset of tests:

- Body Fat %, WHtR, HOMA-IR, HbA1c, hsCRP, ApoB
- Plus optional fitness vs metabolic correlations:
  - VO2 max vs WHtR/HOMA-IR negative correlation
  - Strength/power and gait speed vs WHtR negative correlation

The correlation matrix is defined in `mc_assumptions.json` and used via a Cholesky factor.

## Cognition Practice Effect

Enabled:

- A one-time +2% practice bump at **Year 5 only** for:
  - Processing Speed
  - Working Memory

## Sanity Checks

We added a “decline direction” sanity checker that prints warnings during the decline run if a test moves in the wrong direction beyond tolerance.

Config:

- `sanity_check.enabled`: `true/false`
- `sanity_check.tolerance_rel`: default `0.02` (allows small movement due to noise)
- `sanity_check.tolerance_abs`: default `0.0`

This prints warnings to the console (no log file yet).

## Known Simplifications / Deferred Items

- No hsCRP “spike process” (episodic infection/inflammation) yet.
- No output percentiles, SDs, or full distributions (only mean).
- No formatting of Excel output (a minimal `.xlsx` writer is used for compatibility without external dependencies).
- Improvement ranges are applied as a single-year step (Year 1) rather than multi-year training adaptation.

